### **1. 概述**

#### **1.1. 项目背景**
本项目旨在开发一个 astrbot 插件，作为外部服务与 QQ 之间的“渲染桥梁”，将结构化的 HTTP 请求数据动态转化为信息清晰、视觉突出的图片，从而极大地提升通知消息的传达效率和用户体验。

#### **1.2. 产品目标**
*   **提供标准化的 API 接口**：为外部系统提供一个安全、稳定、易于集成的 HTTP API，用于接收数据并触发图片生成。
*   **实现高度的灵活性和可定制性**：支持管理员在后台配置多个不同的 HTML 模板，并通过 API 请求动态指定使用，以适应不同的业务场景和视觉风格。
*   **优化信息传达效率**：将枯燥的数据转化为美观的图片卡片，使信息在 QQ 聊天中一目了然，帮助用户快速抓住重点。
*   **提供便捷的管理体验**：为插件管理员提供一个直观的图形化配置界面，轻松管理接口、认证和 HTML 模板。

### **2. 功能详述**

#### **2.1. 核心功能：API 接口**
插件需提供一个 HTTP API 端点，用于接收外部系统的 POST 请求。

*   **请求方法**: `POST`
*   **接口路径**: 支持管理员在后台自定义，例如：`/api/render/image`
*   **请求格式**:
    *   **认证 (Authentication)**:
        *   请求头中必须包含 `Authorization` 字段。
        *   认证方案为 `Bearer Token`。
        *   格式: `Authorization: Bearer [管理员在后台设置的令牌]`
    *   **控制元数据 (Control Metadata)**:
        *   通过自定义请求头传递，用以控制渲染和发送逻辑。
        *   `X-Html-Template` (必需): 指定本次渲染所使用的 HTML 模板的**别名**。
        *   `X-Target-Type` (必需): 指定发送目标的类型。值为 `group` (群聊) 或 `private` (私聊)。
        *   `X-Target-Id` (必需): 指定发送目标的具体号码（群号或QQ号）。
    *   **请求体 (Request Body)**:
        *   **Content-Type**: `multipart/form-data`
        *   **内容**: 请求体中仅包含用于填充 HTML 模板的动态数据，以键值对（Key-Value）形式提供。键名应与模板中的占位符相对应。

*   **请求处理流程**:
    1.  插件服务接收到 POST 请求。
    2.  验证 `Authorization` 头中的令牌是否有效。
    3.  校验 `X-Html-Template`, `X-Target-Type`, `X-Target-Id` 三个请求头是否存在且格式正确。
    4.  根据 `X-Html-Template` 的值，查找匹配的预设 HTML 模板。
    5.  提取请求体 (`form-data`) 中的所有键值对。
    6.  将键值对数据填充到 HTML 模板中，替换掉 `{{key}}` 形式的占位符。
    7.  调用底层渲染引擎（如 Puppeteer）将填充后的 HTML 渲染成一张图片。
    8.  根据 `X-Target-Type` 和 `X-Target-Id`，将生成的图片发送到指定的 QQ 聊天。

*   **响应 (Response)**:
    *   **成功**: 返回 `HTTP 200 OK`，响应体可为：`{"status": "success", "message": "Image sent successfully"}`。
    *   **失败**:
        *   `HTTP 400 Bad Request`: 请求格式错误，如缺少必要的请求头、`X-Html-Template` 对应的模板不存在等。响应体应包含明确的错误信息，如：`{"status": "error", "message": "Header 'X-Html-Template' is missing"}`。
        *   `HTTP 401 Unauthorized`: `Authorization` 令牌无效或缺失。
        *   `HTTP 500 Internal Server Error`: 插件内部发生未知错误，如图片渲染失败等。

#### **2.2. 后台管理功能**
插件需提供一个在 astrbot 后台内的可视化配置页面。

*   **通用设置**:
    *   **API 接口路径**: 一个输入框，允许管理员自定义 API 的访问路径。
    *   **认证令牌**: 一个输入框，允许管理员设置和重置 API 的 Bearer Token，并提供复制按钮。
*   **HTML 模板管理**:
    *   以列表形式展示所有已创建的模板，每行显示“模板别名”和“模板描述”。
    *   提供“新增模板”、“编辑”、“删除”功能。
    *   **模板编辑器（新增/编辑）表单**:
        *   **模板别名 (Required)**: 纯文本输入框，作为模板的唯一标识符，与 API 请求头 `X-Html-Template` 的值对应。需进行唯一性校验。
        *   **模板描述**: 可选文本框，用于备注模板用途，方便管理员识别。
        *   **HTML/CSS 代码**: 一个支持代码高亮的大文本域，用于编写包含 `{{占位符}}` 的模板。
        *   **渲染参数**:
            *   图片宽度 (px): 数字输入框，控制生成图片的宽度，高度自适应。
            *   图片质量: 下拉选择框（高/中/低），对应不同的图片压缩率。

### **3. 用户故事**

*   **As a** 系统管理员,
    **I want to** 在后台方便地创建和管理多个带有唯一别名的 HTML 模板,
    **so that** 我可以为公司不同的业务通知（如告警、日报、审核通知）定义不同的、符合品牌形象的图片样式。

*   **As an** 自动化流程开发者,
    **I want to** 通过设置标准的 HTTP Headers 来控制图片的模板和发送目标，并将纯业务数据放在请求体中,
    **so that** 我的 API 调用逻辑清晰、规范，并且能轻松地将任何结构的数据发送到 QQ。

*   **As a** QQ 群成员,
    **I want to** 收到由机器人发送的、格式统一且设计美观的图片通知,
    **so that** 我能从繁杂的聊天信息中快速识别并获取重要通知的要点，提升工作效率。

### **4. 非功能性需求**

*   **性能**: 95% 的 API 请求应在 3 秒内完成从接收到图片发送的全过程。
*   **安全性**: API 接口必须受令牌保护，防止未授权访问。对传入的数据进行基础的清理，防止渲染引擎的潜在漏洞。
*   **易用性**: 后台管理界面应直观易懂，非技术人员也能轻松配置模板。API 的错误提示应清晰明确，方便开发者调试。
*   **可靠性**: 插件服务应保持稳定运行，能够处理一定程度的并发请求，并有日志记录关键的请求和错误信息。
